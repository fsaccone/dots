#!/bin/sh

xset -b
setxkbmap -layout it -option ctrl:nocaps

while true; do
	wireless_interface=$(ip link show | grep -E '^[0-9]+: ' \
	                                  | grep -i 'wl' | cut -d: -f2 \
	                                  | tr -d ' ' | head -n 1 \
	                                  | sed 's/:.*//;s/ //g' | grep '^w')

	if [ -n "$wireless_interface" ]; then
		ssid=$(wpa_cli -i "$wireless_interface" status \
		                                        | grep '^ssid=' \
		                                        | cut -d '=' -f 2)
	fi

	if [ -z "$ssid" ]; then
		ssid="None"
	fi

	battery_device=$(ls /sys/class/power_supply | grep '^BAT' | head -n 1)
	battery=$(cat "/sys/class/power_supply/$battery_device/capacity")%

	case "$(cat /sys/class/power_supply/$battery_device/status)" in
		"Charging")
			battery_status="[âš¡]"
			;;
		"Discharging")
			battery_status="[ğŸ”Œ]"
			;;
		"Full")
			battery_status="[âœ…]"
			;;
		"Not charging")
			battery_status="[âš ï¸]"
			;;
		*)
			battery_status="[â“]"
			;;
	esac

	localdate=$(date +%Y-%m-%d)
	localtime=$(date +%H:%M:%S)
	localzone=$(date +%Z)

	status=$(echo \
	         "ğŸ“¡ $ssid" \
	         " " \
	         "ğŸ”‹ $battery $battery_status" \
	         " " \
	         "$localdate $localtime $localzone" \
	         "")

	xsetroot -name "$status"
	sleep 1
done &

exec dwm &

mpv --wid=0 --loop=inf ~/.local/share/wallpaper.mp4
